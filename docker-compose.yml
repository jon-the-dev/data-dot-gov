name: congress

services:
  # Frontend - React Application
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: production
      args:
        - VITE_API_URL=${VITE_API_URL}
    container_name: congress_frontend_prod
    environment:
      - NODE_ENV=production
      - VITE_API_URL=https://congress-api.local.team-skynet.io
      - VITE_APP_TITLE=Congressional Transparency Platform
      - VITE_ENABLE_ANALYTICS=true
    volumes:
      - frontend_logs:/var/log/nginx
    networks:
      - congress_prod_network
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    labels:
      # Enable Traefik for this service
      - "traefik.enable=true"

      # HTTP Router (redirects to HTTPS)
      - "traefik.http.routers.congress-frontend.entrypoints=http"
      - "traefik.http.routers.congress-frontend.rule=Host(`congress.local.team-skynet.io`)"
      - "traefik.http.routers.congress-frontend.middlewares=https-redirectscheme@file"

      # HTTPS Router (secure)
      - "traefik.http.routers.congress-frontend-secure.entrypoints=https"
      - "traefik.http.routers.congress-frontend-secure.rule=Host(`congress.local.team-skynet.io`)"
      - "traefik.http.routers.congress-frontend-secure.tls=true"
      - "traefik.http.routers.congress-frontend-secure.service=congress-frontend"
      # - "traefik.http.routers.congress-frontend-secure.middlewares=security-headers@file"

      # Network & Service Configuration
      - "traefik.docker.network=backend"
      - "traefik.http.services.congress-frontend.loadbalancer.server.port=80"

  # Backend API - FastAPI Application
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: congress_backend_prod
    environment:
      - ENVIRONMENT=production
      - DEBUG=false
      - LOG_LEVEL=info
      - DATABASE_URL=postgresql://congress_app:${POSTGRES_PASSWORD}@postgres:5432/congress_transparency
      - REDIS_URL=redis://redis:6379/0
      - SECRET_KEY=${SECRET_KEY}
      - DATA_GOV_API_KEY=${DATA_GOV_API_KEY}
      - SENATE_GOV_USERNAME=${SENATE_GOV_USERNAME}
      - SENATE_GOV_PASSWORD=${SENATE_GOV_PASSWORD}
      - CORS_ORIGINS=https://congress.local.team-skynet.io
      - MAX_WORKERS=4
      - API_RATE_LIMIT=1000
      - CACHE_TTL=3600
    volumes:
      - ./data:/app/data:ro
      - ./backend/main.py:/app/main.py:ro
      - backend_logs:/app/logs
    networks:
      - congress_prod_network
      - backend
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    labels:
      # Enable Traefik for this service
      - "traefik.enable=true"

      # HTTP Router (redirects to HTTPS)
      - "traefik.http.routers.congress-api.entrypoints=http"
      - "traefik.http.routers.congress-api.rule=Host(`congress-api.local.team-skynet.io`)"
      - "traefik.http.routers.congress-api.middlewares=https-redirectscheme@file"

      # HTTPS Router (secure)
      - "traefik.http.routers.congress-api-secure.entrypoints=https"
      - "traefik.http.routers.congress-api-secure.rule=Host(`congress-api.local.team-skynet.io`)"
      - "traefik.http.routers.congress-api-secure.tls=true"
      - "traefik.http.routers.congress-api-secure.service=congress-api"
      # - "traefik.http.routers.congress-api-secure.middlewares=api-cors@file,api-rate-limit@file"

      # Network & Service Configuration
      - "traefik.docker.network=backend"
      - "traefik.http.services.congress-api.loadbalancer.server.port=8000"

  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: congress_postgres_prod
    environment:
      POSTGRES_DB: congress_transparency
      POSTGRES_USER: congress_app
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_prod_data:/var/lib/postgresql/data
      - ./db/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
      - ./db/migrations:/docker-entrypoint-initdb.d/migrations
      - postgres_backups:/backups
    networks:
      - congress_prod_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U congress_app -d congress_transparency"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    command: >
      postgres
      -c max_connections=200
      -c shared_buffers=512MB
      -c effective_cache_size=1GB
      -c maintenance_work_mem=128MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=8MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB
      -c log_statement=mod
      -c log_min_duration_statement=1000
      -c log_line_prefix='%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
      -c log_checkpoints=on
      -c log_connections=on
      -c log_disconnections=on
      -c log_lock_waits=on
      -c log_temp_files=0
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: congress_redis_prod
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes:
      - redis_prod_data:/data
      - ./config/redis.conf:/usr/local/etc/redis/redis.conf
    networks:
      - congress_prod_network
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    command: >
      redis-server /usr/local/etc/redis/redis.conf
      --requirepass ${REDIS_PASSWORD}
      --appendonly yes
      --appendfsync everysec
      --maxmemory 1gb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # Data Poller Service
  poller:
    build:
      context: ./poller
      dockerfile: Dockerfile
    container_name: congress_poller_prod
    environment:
      - ENVIRONMENT=production
      - DATABASE_URL=postgresql://congress_app:${POSTGRES_PASSWORD}@postgres:5432/congress_transparency
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - DATA_GOV_API_KEY=${DATA_GOV_API_KEY}
      - SENATE_GOV_USERNAME=${SENATE_GOV_USERNAME}
      - SENATE_GOV_PASSWORD=${SENATE_GOV_PASSWORD}
      - FETCH_SCHEDULE=02:00  # Daily at 2 AM
      - MAX_ITEMS=1000
      - MAX_ITEMS_INCREMENTAL=100
      - CONGRESS=118
      - ENABLE_INCREMENTAL=true
      - RUN_ON_STARTUP=true  # Smart check - only fetches if data is missing or stale
      - DATA_MAX_AGE_HOURS=24  # Consider data stale after 24 hours
    volumes:
      - ./data:/app/data
      - poller_logs:/app/logs
    networks:
      - congress_prod_network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'


  # # Backup Service
  # backup:
  #   image: postgres:15-alpine
  #   container_name: congress_backup_prod
  #   environment:
  #     - PGUSER=congress_app
  #     - PGPASSWORD=${POSTGRES_PASSWORD}
  #     - PGHOST=postgres
  #     - PGDATABASE=congress_transparency
  #     - BACKUP_SCHEDULE=0 1 * * *  # Daily at 1 AM
  #     - BACKUP_RETENTION_DAYS=30
  #     - S3_BUCKET=${BACKUP_S3_BUCKET}
  #     - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
  #     - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
  #   volumes:
  #     - postgres_backups:/backups
  #     - ./scripts/backup-prod.sh:/backup.sh:ro
  #   networks:
  #     - congress_prod_network
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #   restart: unless-stopped
  #   command: >
  #     sh -c "
  #       apk add --no-cache dcron aws-cli &&
  #       echo '$${BACKUP_SCHEDULE} /backup.sh' | crontab - &&
  #       crond -f
  #     "


volumes:
  # Production data volumes - using Docker managed volumes for portability
  postgres_prod_data:
    driver: local

  redis_prod_data:
    driver: local

  postgres_backups:
    driver: local

  # Log volumes
  frontend_logs:
    driver: local
  backend_logs:
    driver: local
  poller_logs:
    driver: local

networks:
  congress_prod_network:
    driver: bridge
    name: congress_prod_network
    ipam:
      config:
        - subnet: 172.25.0.0/16
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "true"
      com.docker.network.driver.mtu: "1500"

  backend:
    external: true
    name: backend