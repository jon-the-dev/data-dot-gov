name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.13'
  NODE_VERSION: '20'

jobs:
  python-quality:
    name: Python Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pipenv
        pipenv install --dev --deploy

    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/Pipfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Run Ruff (Fast Linter)
      run: |
        pipenv run python -m ruff check . --output-format=github
      continue-on-error: false

    - name: Run Black (Code Formatting Check)
      run: |
        pipenv run python -m black --check --diff .
      continue-on-error: false

    - name: Run isort (Import Sorting Check)
      run: |
        pipenv run python -m isort --check-only --diff .
      continue-on-error: false

    - name: Run Flake8 (Style Guide Enforcement)
      run: |
        pipenv run python -m flake8 . --format='::error file=%(path)s,line=%(row)d,col=%(col)d::%(code)s: %(text)s'
      continue-on-error: false

    - name: Run MyPy (Type Checking)
      run: |
        pipenv run python -m mypy . --ignore-missing-imports
      continue-on-error: false

    - name: Run Bandit (Security Linting)
      run: |
        pipenv run python -m bandit -r . -x tests/,migrations/,node_modules/,.venv/,venv/ -f json -o bandit-report.json
        pipenv run python -m bandit -r . -x tests/,migrations/,node_modules/,.venv/,venv/
      continue-on-error: false

    - name: Run Pylint (Comprehensive Analysis)
      run: |
        pipenv run python -m pylint --rcfile=.pylintrc *.py --output-format=colorized
      continue-on-error: true  # Allow to continue even if pylint finds issues

    - name: Upload Bandit Security Report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: bandit-security-report
        path: bandit-report.json

  frontend-quality:
    name: Frontend Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install frontend dependencies
      working-directory: ./frontend
      run: |
        npm ci

    - name: Cache node modules
      uses: actions/cache@v3
      with:
        path: frontend/node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('frontend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Run ESLint
      working-directory: ./frontend
      run: |
        npm run lint:strict
      continue-on-error: false

    - name: Run Prettier (Format Check)
      working-directory: ./frontend
      run: |
        npm run format:check
      continue-on-error: false

    - name: Run TypeScript Type Checking
      working-directory: ./frontend
      run: |
        npm run type-check:strict
      continue-on-error: false

    - name: Build Frontend (Production Test)
      working-directory: ./frontend
      run: |
        npm run build
      continue-on-error: false

  pre-commit-validation:
    name: Pre-commit Hooks Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install pre-commit
      run: |
        python -m pip install --upgrade pip
        pip install pre-commit

    - name: Cache pre-commit environments
      uses: actions/cache@v3
      with:
        path: ~/.cache/pre-commit
        key: pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}
        restore-keys: |
          pre-commit-

    - name: Run pre-commit hooks
      run: |
        pre-commit run --all-files --show-diff-on-failure
      continue-on-error: false

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pipenv safety detect-secrets

    - name: Run Safety (Dependency Vulnerability Check)
      run: |
        pipenv requirements > requirements.txt
        safety check -r requirements.txt --json --output safety-report.json
        safety check -r requirements.txt
      continue-on-error: true

    - name: Run detect-secrets (Secret Scanning)
      run: |
        detect-secrets scan --baseline .secrets.baseline --all-files
      continue-on-error: false

    - name: Upload Safety Report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: safety-vulnerability-report
        path: safety-report.json

  documentation-quality:
    name: Documentation Quality
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Install markdownlint
      run: |
        npm install -g markdownlint-cli

    - name: Run Markdown Linting
      run: |
        markdownlint --config .markdownlint.json *.md
      continue-on-error: true

    - name: Check for TODO/FIXME comments
      run: |
        echo "Checking for TODO/FIXME comments..."
        if grep -r "TODO\|FIXME\|XXX" --include="*.py" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" . ; then
          echo "Found TODO/FIXME comments. Consider addressing them."
          exit 0  # Don't fail the build for this
        else
          echo "No TODO/FIXME comments found."
        fi

  quality-summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [python-quality, frontend-quality, pre-commit-validation, security-scan, documentation-quality]
    if: always()
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Quality Gate Summary
      run: |
        echo "## Code Quality Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Job Status:" >> $GITHUB_STEP_SUMMARY
        echo "- Python Quality: ${{ needs.python-quality.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Frontend Quality: ${{ needs.frontend-quality.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Pre-commit Validation: ${{ needs.pre-commit-validation.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Security Scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Documentation Quality: ${{ needs.documentation-quality.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Determine overall status
        if [[ "${{ needs.python-quality.result }}" == "success" && "${{ needs.frontend-quality.result }}" == "success" && "${{ needs.pre-commit-validation.result }}" == "success" ]]; then
          echo "### ✅ Quality Gate: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "All critical quality checks passed!" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ❌ Quality Gate: FAILED" >> $GITHUB_STEP_SUMMARY
          echo "One or more critical quality checks failed. Please review the errors above." >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Code Quality Standards:" >> $GITHUB_STEP_SUMMARY
        echo "- **Python**: Black formatting, Ruff linting, MyPy type checking" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend**: ESLint + Prettier, TypeScript strict mode" >> $GITHUB_STEP_SUMMARY
        echo "- **Security**: Bandit, Safety, Secret detection" >> $GITHUB_STEP_SUMMARY
        echo "- **Documentation**: Markdown linting, comment standards" >> $GITHUB_STEP_SUMMARY

    - name: Fail if critical jobs failed
      if: needs.python-quality.result == 'failure' || needs.frontend-quality.result == 'failure' || needs.pre-commit-validation.result == 'failure'
      run: |
        echo "❌ Critical quality checks failed!"
        exit 1